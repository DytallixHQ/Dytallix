version: '3.8'

x-node-env: &node-env
  DYTALLIX_CHAIN_ID: dytallix-testnet-1
  DYTALLIX_DATA_DIR: /var/lib/dytallix/data
  DYTALLIX_ENABLE_GOVERNANCE: "true"
  DYTALLIX_ENABLE_STAKING: "true"
  DYTALLIX_BLOCK_INTERVAL_MS: "6000"
  DYTALLIX_EMPTY_BLOCKS: "true"
  DYTALLIX_METRICS: "1"
  DYTALLIX_METRICS_ADDR: 0.0.0.0:9464
  DYTALLIX_GOV_MIN_DEPOSIT: "10000000"
  DYTALLIX_GOV_DEPOSIT_PERIOD: "172800"
  DYTALLIX_GOV_VOTING_PERIOD: "604800"
  DYTALLIX_GOV_QUORUM_BPS: "3333"
  DYTALLIX_GOV_THRESHOLD_BPS: "5000"
  DYTALLIX_GOV_VETO_BPS: "3333"
  DYTALLIX_STAKING_REWARD_RATE_BPS: "500"
  DYTALLIX_LOG_LEVEL: info
  # Enable API runtime event mocks so the dashboard shows live blocks via websocket
  RUNTIME_MOCKS: "1"

x-node-service: &node-service
  build:
    context: ../..
    dockerfile: DytallixLiteLaunch/node/Dockerfile
  restart: unless-stopped
  environment:
    <<: *node-env
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"
  healthcheck:
    test: ["CMD", "curl", "-sf", "http://localhost:3030/health"]
    interval: 30s
    timeout: 10s
    retries: 5

services:
  # Primary validator and RPC node
  node:
    <<: *node-service
    container_name: dytallix-node
    volumes:
      - node-data:/var/lib/dytallix
      - ./genesis.json:/etc/dytallix/genesis.json:ro
      - ./config:/etc/dytallix/config:ro
    ports:
      - "3030:3030"  # Node HTTP API
      - "9464:9464"  # Prometheus metrics (if enabled)
    environment:
      <<: *node-env
      DYTALLIX_NODE_ROLE: validator
      DYTALLIX_VALIDATOR_NAME: dytallix-testnet-validator

volumes:
  node-data:
    driver: local

networks:
  default:
    name: dytallix-lite-network
    driver: bridge