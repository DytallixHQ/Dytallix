version: '3.8'

services:
  dytallix-node:
    image: tendermint/tendermint:v0.34.24
    container_name: dytallix-node
    ports:
      - "26656:26656"
      - "26657:26657"
    user: "0"
    entrypoint: ["/bin/sh"]
    command: 
      - -c
      - |
        if [ ! -f /tendermint/config/genesis.json ]; then
          tendermint init validator --home /tendermint
        fi
        tendermint node --home /tendermint --rpc.laddr tcp://0.0.0.0:26657 --p2p.laddr tcp://0.0.0.0:26656 --proxy_app=kvstore
    volumes:
      - tendermint_data:/tendermint
    networks:
      - dytallix-network

  dytallix-faucet:
    build: 
      context: ../faucet
      dockerfile: Dockerfile
    container_name: dytallix-faucet
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - CHAIN_ID=dytallix-testnet-1
      - RPC_ENDPOINT=http://dytallix-node:26657
      - GRPC_ENDPOINT=http://dytallix-node:9090
      - FAUCET_AMOUNT=1000000udyt
      - FAUCET_MNEMONIC=${FAUCET_MNEMONIC}
      - RATE_LIMIT_WINDOW_MS=3600000
      - RATE_LIMIT_MAX_REQUESTS=5
      - IP_COOLDOWN_MS=1800000
      - CORS_ORIGIN=*
      - REDIS_ENABLED=false
    depends_on:
      - dytallix-node
    networks:
      - dytallix-network
    restart: unless-stopped

  faucet-frontend:
    image: nginx:alpine
    container_name: faucet-frontend
    ports:
      - "80:80"
    volumes:
      - ./faucet-frontend:/usr/share/nginx/html:ro
      - ./nginx-faucet-fixed.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - dytallix-faucet
    networks:
      - dytallix-network
    restart: unless-stopped

volumes:
  tendermint_data:

networks:
  dytallix-network:
    driver: bridge
