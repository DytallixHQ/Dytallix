services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: quantumvault
      POSTGRES_USER: quantumvault
      POSTGRES_PASSWORD: quantumvault
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U quantumvault -d quantumvault"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - qv_pg:/var/lib/postgresql/data

  vault:
    image: hashicorp/vault:1.17
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    ports:
      - "8201:8200"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8200/v1/sys/health"]
      interval: 5s
      timeout: 3s
      retries: 20

  anvil:
    image: ghcr.io/foundry-rs/foundry:stable
    command: ["anvil --host 0.0.0.0 --port 9545 --chain-id 31337"]
    ports:
      - "8546:9545"
    healthcheck:
      test: ["CMD", "sh", "-lc", "cast chain-id --rpc-url http://127.0.0.1:9545 >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  contracts-deployer:
    image: node:20-alpine
    working_dir: /work
    volumes:
      - ./contracts:/work
      - qv_contracts:/out
    environment:
      RPC_URL: http://anvil:9545
      DEPLOYER_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
      OUT_DIR: /out
    command: ["sh", "-lc", "npm ci && node deploy.mjs"]
    depends_on:
      anvil:
        condition: service_healthy

  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    environment:
      QV_ENV: dev
      QV_HTTP_ADDR: 0.0.0.0:8080
      QV_DB_DSN: postgres://quantumvault:quantumvault@postgres:5432/quantumvault?sslmode=disable
      QV_JWT_ISSUER: quantumvault
      QV_JWT_ACCESS_TTL: 15m
      QV_JWT_REFRESH_TTL: 720h
      QV_JWT_SECRET: "change-me-in-prod"
      QV_ADMIN_EMAIL: hello@dytallix.com
      QV_ADMIN_PASSWORD: "password12345"
      QV_ADMIN_BOOTSTRAP_FORCE: "true"
      QV_VAULT_ADDR: http://vault:8200
      QV_VAULT_TOKEN: root
      QV_ETH_RPC_URL: http://anvil:9545
      QV_ETH_CHAIN_ID: "31337"
      QV_ETH_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
      QV_ATTESTATION_CONTRACT_FILE: /contracts/attestation.json
      QV_CORS_ORIGIN: "https://localhost:8443"
    depends_on:
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy
      contracts-deployer:
        condition: service_completed_successfully
    volumes:
      - qv_contracts:/contracts:ro
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://127.0.0.1:8080/api/health"]
      interval: 5s
      timeout: 3s
      retries: 30

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_BASE: "https://localhost:8443/api"
    depends_on:
      backend:
        condition: service_healthy

  caddy:
    image: caddy:2-alpine
    ports:
      - "8443:8443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - qv_caddy_data:/data
      - qv_caddy_config:/config
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_started

volumes:
  qv_pg:
  qv_caddy_data:
  qv_caddy_config:
  qv_contracts:
