x-node-env: &node-env
  DYT_CHAIN_ID: dytallix-gov-e2e
  DYT_DATA_DIR: /var/lib/dytallix/data
  DYT_ENABLE_GOVERNANCE: "true"
  DYT_ENABLE_STAKING: "true"
  DYT_BLOCK_INTERVAL_MS: "2000"
  DYT_EMPTY_BLOCKS: "true"
  DY_METRICS: "1"
  DY_METRICS_ADDR: 0.0.0.0:9464
  DYT_GOV_MIN_DEPOSIT: "1000000000"
  DYT_GOV_DEPOSIT_PERIOD: "10"
  DYT_GOV_VOTING_PERIOD: "15"
  DYT_GOV_QUORUM_BPS: "3333"
  DYT_GOV_THRESHOLD_BPS: "5000"
  DYT_GOV_VETO_BPS: "3333"
  DYT_STAKING_REWARD_RATE_BPS: "500"  # 5% initial reward rate governed via staking_reward_rate param

x-node-service: &node-service
  build:
    context: ..
    dockerfile: dytallix-lean-launch/Dockerfile.node
  image: dytallix-lean-node:local
  restart: unless-stopped
  environment:
    <<: *node-env
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"
  healthcheck:
    test: ["CMD", "curl", "-sf", "http://localhost:3003/status"]
    interval: 10s
    timeout: 5s
    retries: 12

services:
  seed:
    <<: *node-service
    container_name: dyt-seed
    volumes:
      - seed-data:/var/lib/dytallix
    ports:
      - "3010:3003"
      - "9464:9464"
    environment:
      <<: *node-env
      DYT_NODE_ROLE: seed
      DYT_EMPTY_BLOCKS: "true"  # enable empty blocks so heights advance for governance

  validator1:
    <<: *node-service
    container_name: dyt-validator-1
    volumes:
      - val1-data:/var/lib/dytallix
    ports:
      - "3011:3003"
      - "9465:9464"
    environment:
      <<: *node-env
      DYT_NODE_ROLE: validator
      DYT_VALIDATOR_NAME: validator1
      DYT_EMPTY_BLOCKS: "true"   # was false; allow empty blocks for governance periods
      DYT_STAKING_REWARD_RATE_BPS: "500"

  validator2:
    <<: *node-service
    container_name: dyt-validator-2
    volumes:
      - val2-data:/var/lib/dytallix
    ports:
      - "3012:3003"
      - "9466:9464"
    environment:
      <<: *node-env
      DYT_NODE_ROLE: validator
      DYT_VALIDATOR_NAME: validator2
      DYT_EMPTY_BLOCKS: "true"   # enable empty blocks
      DYT_STAKING_REWARD_RATE_BPS: "500"

  validator3:
    <<: *node-service
    container_name: dyt-validator-3
    volumes:
      - val3-data:/var/lib/dytallix
    ports:
      - "3013:3003"
      - "9468:9464"
    environment:
      <<: *node-env
      DYT_NODE_ROLE: validator
      DYT_VALIDATOR_NAME: validator3
      DYT_EMPTY_BLOCKS: "true"   # enable empty blocks
      DYT_STAKING_REWARD_RATE_BPS: "500"

  rpc:
    <<: *node-service
    container_name: dyt-rpc
    volumes:
      - rpc-data:/var/lib/dytallix
    ports:
      - "3014:3003"
      - "9467:9464"
    environment:
      <<: *node-env
      DYT_NODE_ROLE: rpc
      DYT_BLOCK_INTERVAL_MS: "800"
      DYT_EMPTY_BLOCKS: "true"
      DYT_STAKING_REWARD_RATE_BPS: "500"
    depends_on:
      - seed
      - validator1
      - validator2
      - validator3

volumes:
  seed-data:
  val1-data:
  val2-data:
  val3-data:
  rpc-data:
