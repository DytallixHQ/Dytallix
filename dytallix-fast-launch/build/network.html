<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Network - Dytallix Blockchain Explorer & Dashboard</title>
  <link rel="stylesheet" href="../shared-assets/styles.css">
</head>
<body>
  <header class="global-header">
    <div class="container">
      <div class="header-content">
        <a href="../homepage/index.html" class="logo">
          <img src="../shared-assets/logo.svg" alt="Dytallix Logo">
          <span>Dytallix</span>
        </a>
        <nav>
          <ul class="nav-menu">
            <li><a href="../homepage/index.html">Home</a></li>
            <li><a href="./index.html">Build</a></li>
            <li><a href="../quantumvault/">QuantumVault</a></li>
            <li><a href="./network.html" class="active">Network</a></li>
            <li><a href="../quantumvault/#demo" class="btn btn-primary btn-small">Request Demo</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <section class="page-hero is-dark">
    <div class="container page-hero-content">
      <span class="hero-eyebrow">Network</span>
      <h1 class="hero-title">Blockchain Explorer & Network Health</h1>
      <p class="hero-subtitle">
        Monitor real-time network activity, explore blocks and transactions, and track PQC signature distribution across the Dytallix blockchain.
      </p>
      
      <!-- Key Network Metrics -->
      <div class="hero-metrics">
        <div class="metric metric-card is-dark">
          <span class="metric-label">Latest Block</span>
          <span class="metric-value" id="latest-block">...</span>
          <span class="metric-trend" id="latest-block-time">...</span>
        </div>
        <div class="metric metric-card is-dark">
          <span class="metric-label">Block Time</span>
          <span class="metric-value" id="avg-block-time">...</span>
          <span class="metric-trend is-up" id="block-time-trend">Calculating...</span>
        </div>
        <div class="metric metric-card is-dark">
          <span class="metric-label">Mempool Size</span>
          <span class="metric-value" id="mempool-size">...</span>
          <span class="metric-trend" id="mempool-trend">Pending txs</span>
        </div>
        <div class="metric metric-card is-dark">
          <span class="metric-label">Active Validators</span>
          <span class="metric-value" id="active-validators">...</span>
          <span class="metric-trend" id="validators-trend">Securing network</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Search Section -->
  <section class="section">
    <div class="container">
      <article class="card">
        <h3 class="card-title">üîç Explore the Blockchain</h3>
        <p class="card-content">Search by address, transaction hash, block number, or validator public key.</p>
        <form class="grid grid-2 mt-2" role="search" id="blockchain-search">
          <label for="explorer-search" class="sr-only">Search blockchain</label>
          <input 
            id="explorer-search" 
            type="search" 
            class="form-input" 
            placeholder="Enter address, tx hash, block height, or validator key"
            style="padding: 0.85rem 1rem; border-radius: var(--radius-md); border: 1px solid rgba(148, 163, 184, 0.32); background: rgba(7, 15, 31, 0.5); color: var(--text-primary); font-size: 0.95rem;">
          <button class="btn btn-primary" type="submit">Search</button>
        </form>
        <div class="chip-group mt-3" role="group" aria-label="Signature filters">
          <span class="form-label" style="color: var(--text-muted); font-size: 0.9rem;">Filter by PQC algorithm:</span>
          <button class="chip is-active" type="button" style="background: rgba(124, 135, 255, 0.25); border: 1px solid rgba(124, 135, 255, 0.4); padding: 0.4rem 0.85rem; border-radius: var(--radius-full); color: var(--text-primary); cursor: pointer;">Kyber</button>
          <button class="chip is-active" type="button" style="background: rgba(124, 135, 255, 0.25); border: 1px solid rgba(124, 135, 255, 0.4); padding: 0.4rem 0.85rem; border-radius: var(--radius-full); color: var(--text-primary); cursor: pointer;">Dilithium</button>
          <button class="chip is-active" type="button" style="background: rgba(124, 135, 255, 0.25); border: 1px solid rgba(124, 135, 255, 0.4); padding: 0.4rem 0.85rem; border-radius: var(--radius-full); color: var(--text-primary); cursor: pointer;">SPHINCS+</button>
        </div>
      </article>
    </div>
  </section>

  <!-- Network Dashboard KPIs -->
  <section class="section is-alt">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Network Health Dashboard</h2>
        <p class="section-subtitle">Real-time performance metrics and operational insights</p>
      </div>
      
      <div class="grid grid-3">
        <article class="card">
          <h3 class="card-title">üìä Transaction Throughput</h3>
          <div class="stacked-list">
            <div class="stacked-list-item">
              <span>Last 24 Hours</span>
              <span class="badge badge-success" id="tx-24h">...</span>
            </div>
            <div class="stacked-list-item">
              <span>Transactions/Second (TPS)</span>
              <span class="badge" id="current-tps">...</span>
            </div>
            <div class="stacked-list-item">
              <span>Peak TPS (24h)</span>
              <span class="badge" id="peak-tps">...</span>
            </div>
            <div class="stacked-list-item">
              <span>Average Tx Fee</span>
              <span class="badge" id="avg-tx-fee">...</span>
            </div>
          </div>
        </article>

        <article class="card">
          <h3 class="card-title">üîê PQC Signature Distribution</h3>
          <div class="stacked-list">
            <div class="stacked-list-item">
              <span>Kyber (Encryption)</span>
              <span class="badge badge-info" id="kyber-pct">...</span>
            </div>
            <div class="stacked-list-item">
              <span>Dilithium (Signing)</span>
              <span class="badge badge-info" id="dilithium-pct">...</span>
            </div>
            <div class="stacked-list-item">
              <span>SPHINCS+ (Stateless)</span>
              <span class="badge badge-info" id="sphincs-pct">...</span>
            </div>
            <div class="stacked-list-item">
              <span>Verification Success</span>
              <span class="badge badge-success" id="verification-success">...</span>
            </div>
          </div>
        </article>

        <article class="card">
          <h3 class="card-title">‚ö° Network Performance</h3>
          <div class="stacked-list">
            <div class="stacked-list-item">
              <span>Average Block Time</span>
              <span class="badge badge-success" id="perf-block-time">...</span>
            </div>
            <div class="stacked-list-item">
              <span>Block Propagation</span>
              <span class="badge badge-success" id="block-propagation">...</span>
            </div>
            <div class="stacked-list-item">
              <span>Network Latency</span>
              <span class="badge" id="network-latency">...</span>
            </div>
            <div class="stacked-list-item">
              <span>Blocks (24h)</span>
              <span class="badge badge-success" id="blocks-24h">...</span>
            </div>
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- Live Blockchain Data -->
  <section class="section">
    <div class="container">
      <h2 class="section-title">Live Blockchain Activity</h2>
      
      <div class="grid grid-2 mt-4">
        <!-- Recent Blocks -->
        <article class="card table-card">
          <div style="margin-bottom: 1rem;">
            <h3 class="card-title">üì¶ Recent Blocks</h3>
            <p class="card-content">Live block feed with PQC signature distribution</p>
          </div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 1px solid var(--surface-border);">
                  <th style="padding: 0.75rem; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">Block</th>
                  <th style="padding: 0.75rem; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">Tx</th>
                  <th style="padding: 0.75rem; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">Size</th>
                  <th style="padding: 0.75rem; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">Validator</th>
                </tr>
              </thead>
              <tbody id="block-feed">
                <tr style="border-bottom: 1px solid rgba(87, 113, 153, 0.15);">
                  <td style="padding: 0.75rem;"><strong style="color: var(--text-primary);">#145,892</strong><br><span style="font-size: 0.85rem; color: var(--text-muted);">2s ago</span></td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">45</td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">128 KB</td>
                  <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">dyt1abc...</span></td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(87, 113, 153, 0.15);">
                  <td style="padding: 0.75rem;"><strong style="color: var(--text-primary);">#145,891</strong><br><span style="font-size: 0.85rem; color: var(--text-muted);">5s ago</span></td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">52</td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">142 KB</td>
                  <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">dyt1xyz...</span></td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(87, 113, 153, 0.15);">
                  <td style="padding: 0.75rem;"><strong style="color: var(--text-primary);">#145,890</strong><br><span style="font-size: 0.85rem; color: var(--text-muted);">8s ago</span></td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">38</td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">98 KB</td>
                  <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">dyt1def...</span></td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(87, 113, 153, 0.15);">
                  <td style="padding: 0.75rem;"><strong style="color: var(--text-primary);">#145,889</strong><br><span style="font-size: 0.85rem; color: var(--text-muted);">11s ago</span></td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">61</td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">156 KB</td>
                  <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">dyt1ghi...</span></td>
                </tr>
                <tr>
                  <td style="padding: 0.75rem;"><strong style="color: var(--text-primary);">#145,888</strong><br><span style="font-size: 0.85rem; color: var(--text-muted);">14s ago</span></td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">47</td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">119 KB</td>
                  <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">dyt1jkl...</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </article>

        <!-- Recent Transactions -->
        <article class="card table-card">
          <div style="margin-bottom: 1rem;">
            <h3 class="card-title">üí≥ Recent Transactions</h3>
            <p class="card-content">Latest verified PQC transactions</p>
          </div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 1px solid var(--surface-border);">
                  <th style="padding: 0.75rem; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">Tx Hash</th>
                  <th style="padding: 0.75rem; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">Type</th>
                  <th style="padding: 0.75rem; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">Amount</th>
                  <th style="padding: 0.75rem; text-align: left; color: var(--text-muted); font-weight: 600; font-size: 0.85rem;">Status</th>
                </tr>
              </thead>
              <tbody id="tx-feed">
                <tr style="border-bottom: 1px solid rgba(87, 113, 153, 0.15);">
                  <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">0xf8a3...</span><br><span style="font-size: 0.85rem; color: var(--text-muted);">3s ago</span></td>
                  <td style="padding: 0.75rem;"><span class="badge badge-info" style="font-size: 0.75rem;">Kyber</span></td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">12.5 DYT</td>
                  <td style="padding: 0.75rem;"><span class="badge badge-success" style="font-size: 0.75rem;">Confirmed</span></td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(87, 113, 153, 0.15);">
                  <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">0x2b91...</span><br><span style="font-size: 0.85rem; color: var(--text-muted);">4s ago</span></td>
                  <td style="padding: 0.75rem;"><span class="badge" style="font-size: 0.75rem; background: rgba(147, 51, 234, 0.25); border: 1px solid rgba(147, 51, 234, 0.4);">Dilithium</span></td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">8.2 DYT</td>
                  <td style="padding: 0.75rem;"><span class="badge badge-success" style="font-size: 0.75rem;">Confirmed</span></td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(87, 113, 153, 0.15);">
                  <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">0x7c4d...</span><br><span style="font-size: 0.85rem; color: var(--text-muted);">6s ago</span></td>
                  <td style="padding: 0.75rem;"><span class="badge" style="font-size: 0.75rem; background: rgba(245, 158, 11, 0.25); border: 1px solid rgba(245, 158, 11, 0.4);">SPHINCS+</span></td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">3.7 DYT</td>
                  <td style="padding: 0.75rem;"><span class="badge badge-success" style="font-size: 0.75rem;">Confirmed</span></td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(87, 113, 153, 0.15);">
                  <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">0x9a18...</span><br><span style="font-size: 0.85rem; color: var(--text-muted);">7s ago</span></td>
                  <td style="padding: 0.75rem;"><span class="badge badge-info" style="font-size: 0.75rem;">Kyber</span></td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">25.0 DYT</td>
                  <td style="padding: 0.75rem;"><span class="badge badge-success" style="font-size: 0.75rem;">Confirmed</span></td>
                </tr>
                <tr>
                  <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">0x3f62...</span><br><span style="font-size: 0.85rem; color: var(--text-muted);">9s ago</span></td>
                  <td style="padding: 0.75rem;"><span class="badge" style="font-size: 0.75rem; background: rgba(147, 51, 234, 0.25); border: 1px solid rgba(147, 51, 234, 0.4);">Dilithium</span></td>
                  <td style="padding: 0.75rem; color: var(--text-secondary);">15.8 DYT</td>
                  <td style="padding: 0.75rem;"><span class="badge badge-success" style="font-size: 0.75rem;">Confirmed</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- Validator Information -->
  <section class="section is-alt">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Active Validators</h2>
        <p class="section-subtitle">Network security powered by distributed PQC-secured validators</p>
      </div>
      
      <div class="grid grid-4">
        <article class="card">
          <h4 class="card-title" style="font-size: 1rem;">Total Validators</h4>
          <div class="metric-value" style="font-size: 2.5rem; color: var(--primary-blue);" id="total-validators">...</div>
          <p class="card-content mb-0" id="validators-location">Loading...</p>
        </article>
        
        <article class="card">
          <h4 class="card-title" style="font-size: 1rem;">Total Stake</h4>
          <div class="metric-value" style="font-size: 2.5rem; color: var(--primary-blue);" id="total-stake">...</div>
          <p class="card-content mb-0">DYT tokens staked</p>
        </article>
        
        <article class="card">
          <h4 class="card-title" style="font-size: 1rem;">Avg. Stake</h4>
          <div class="metric-value" style="font-size: 2.5rem; color: var(--primary-blue);" id="avg-stake">...</div>
          <p class="card-content mb-0">DYT per validator</p>
        </article>
        
        <article class="card">
          <h4 class="card-title" style="font-size: 1rem;">Active Validators</h4>
          <div class="metric-value" style="font-size: 2.5rem; color: var(--success-green);" id="active-validators-count">...</div>
          <p class="card-content mb-0">Currently validating</p>
        </article>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="global-footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h4>Platform</h4>
          <ul class="footer-links">
            <li><a href="../homepage/index.html">Home</a></li>
            <li><a href="./index.html">Build</a></li>
            <li><a href="../quantumvault/">QuantumVault</a></li>
            <li><a href="./network.html">Network</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Developer</h4>
          <ul class="footer-links">
            <li><a href="./docs.html">Documentation</a></li>
            <li><a href="./dashboard.html">Dashboard</a></li>
            <li><a href="#api">API Reference</a></li>
            <li><a href="#sdk">SDKs</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Network</h4>
          <ul class="footer-links">
            <li><a href="./network.html">Explorer</a></li>
            <li><a href="./network.html#metrics">Network Stats</a></li>
            <li><a href="#validators">Validators</a></li>
            <li><a href="#faucet">Testnet Faucet</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h4>Company</h4>
          <ul class="footer-links">
            <li><a href="#about">About</a></li>
            <li><a href="#blog">Blog</a></li>
            <li><a href="#careers">Careers</a></li>
            <li><a href="#contact">Contact</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Dytallix. All rights reserved. | <a href="#privacy">Privacy Policy</a> | <a href="#terms">Terms of Service</a></p>
      </div>
    </div>
  </footer>

  <script>
    // Blockchain API configuration
    const BLOCKCHAIN_API = 'http://localhost:3003';
    
    // State management
    let latestBlockHeight = 145892;
    let isConnected = false;
    let ws = null;
    let blockTimestamps = []; // Track recent block timestamps for calculating avg block time
    let txCountLast24h = 0;
    let peakTPS = 0;
    let pqcStats = { kyber: 0, dilithium: 0, sphincs: 0, total: 0 };

    // Connect to WebSocket for real-time updates
    function connectWebSocket() {
      try {
        ws = new WebSocket(`ws://localhost:3003/ws`);
        
        ws.onopen = () => {
          console.log('‚úÖ Connected to blockchain WebSocket');
          isConnected = true;
          updateConnectionStatus(true);
        };
        
        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            console.log('üì® WebSocket message:', data);
            
            if (data.message_type === 'new_block') {
              handleNewBlock(data.data);
            } else if (data.message_type === 'new_transaction') {
              handleNewTransaction(data.data);
            }
          } catch (e) {
            console.error('Error parsing WebSocket message:', e);
          }
        };
        
        ws.onerror = (error) => {
          console.error('‚ùå WebSocket error:', error);
          isConnected = false;
          updateConnectionStatus(false);
        };
        
        ws.onclose = () => {
          console.log('üîå WebSocket disconnected. Reconnecting in 5s...');
          isConnected = false;
          updateConnectionStatus(false);
          setTimeout(connectWebSocket, 5000);
        };
      } catch (e) {
        console.error('Failed to connect WebSocket:', e);
        updateConnectionStatus(false);
      }
    }

    // Fetch blockchain stats
    async function fetchBlockchainStats() {
      try {
        const response = await fetch(`${BLOCKCHAIN_API}/stats`);
        const data = await response.json();
        
        // API returns data directly, not wrapped in success/data
        if (data) {
          updateStats(data);
        }
      } catch (e) {
        console.error('Error fetching stats:', e);
      }
    }

    // Fetch recent blocks
    async function fetchRecentBlocks() {
      try {
        const response = await fetch(`${BLOCKCHAIN_API}/blocks?limit=100`);
        const data = await response.json();
        
        // API returns { blocks: [...] } format
        if (data && data.blocks) {
          analyzeBlocks(data.blocks);
          updateBlocksFeed(data.blocks.slice(0, 5));
        }
      } catch (e) {
        console.error('Error fetching blocks:', e);
      }
    }

    // Fetch staking stats
    async function fetchStakingStats() {
      try {
        const response = await fetch(`${BLOCKCHAIN_API}/staking/stats`);
        const data = await response.json();
        
        if (data) {
          updateStakingStats(data);
        }
      } catch (e) {
        console.error('Error fetching staking stats:', e);
        // Use mock data if endpoint doesn't exist
        updateStakingStats({
          total_validators: 125,
          active_validators: 118,
          total_stake: 15750000
        });
      }
    }

    // Fetch validators
    async function fetchValidators() {
      try {
        const response = await fetch(`${BLOCKCHAIN_API}/staking/validators`);
        const data = await response.json();
        
        if (data) {
          updateValidatorStats(data);
        }
      } catch (e) {
        console.error('Error fetching validators:', e);
        // Use mock data if endpoint doesn't exist
        updateValidatorStats([
          { total_stake: 125000 },
          { total_stake: 130000 },
          { total_stake: 135000 }
        ]);
      }
    }

    // Analyze blocks for metrics
    function analyzeBlocks(blocks) {
      if (!blocks || blocks.length === 0) return;
      
      // Calculate average block time
      const timestamps = blocks.map(b => b.timestamp).sort((a, b) => b - a);
      blockTimestamps = timestamps;
      
      if (timestamps.length > 1) {
        let totalDiff = 0;
        let count = 0;
        for (let i = 0; i < timestamps.length - 1; i++) {
          const diff = timestamps[i] - timestamps[i + 1];
          if (diff > 0 && diff < 300) { // Ignore anomalies > 5min
            totalDiff += diff;
            count++;
          }
        }
        if (count > 0) {
          const avgBlockTime = totalDiff / count;
          updateElement('avg-block-time', `${avgBlockTime.toFixed(1)}s`);
          updateElement('perf-block-time', `${avgBlockTime.toFixed(1)}s`);
          updateElement('block-time-trend', `Avg over ${count} blocks`);
        }
      }
      
      // Calculate transaction throughput
      const now = Date.now() / 1000;
      const last24h = now - 86400;
      const blocksLast24h = blocks.filter(b => b.timestamp >= last24h);
      const totalTx = blocksLast24h.reduce((sum, b) => sum + (b.txs ? b.txs.length : 0), 0);
      
      txCountLast24h = totalTx;
      updateElement('tx-24h', `${totalTx.toLocaleString()} tx`);
      updateElement('blocks-24h', `${blocksLast24h.length.toLocaleString()} blocks`);
      
      // Calculate TPS
      if (blocksLast24h.length > 0) {
        const currentTPS = (totalTx / 86400).toFixed(2);
        updateElement('current-tps', `~${currentTPS}`);
        
        // Calculate peak TPS (using 5-minute windows)
        let maxWindowTPS = 0;
        const windowSize = 300; // 5 minutes
        for (let i = 0; i < blocksLast24h.length; i++) {
          const windowStart = blocksLast24h[i].timestamp;
          const windowEnd = windowStart + windowSize;
          const windowBlocks = blocksLast24h.filter(b => b.timestamp >= windowStart && b.timestamp < windowEnd);
          const windowTx = windowBlocks.reduce((sum, b) => sum + (b.txs ? b.txs.length : 0), 0);
          const windowTPS = windowTx / windowSize;
          maxWindowTPS = Math.max(maxWindowTPS, windowTPS);
        }
        peakTPS = maxWindowTPS;
        updateElement('peak-tps', maxWindowTPS.toFixed(2));
      }
      
      // Estimate avg tx fee (placeholder - would need actual tx data)
      updateElement('avg-tx-fee', '~0.0001 DYT');
      
      // Estimate block propagation (placeholder)
      updateElement('block-propagation', '< 500ms');
      updateElement('network-latency', 'Local node');
    }

    // Update stats display
    function updateStats(stats) {
      if (stats.height !== undefined) {
        latestBlockHeight = stats.height;
        updateElement('latest-block', stats.height.toLocaleString());
      }
      
      if (stats.mempool_size !== undefined) {
        updateElement('mempool-size', stats.mempool_size.toLocaleString());
        updateElement('mempool-trend', stats.mempool_size === 1 ? '1 pending tx' : `${stats.mempool_size} pending txs`);
      }
    }

    // Update staking stats
    function updateStakingStats(stats) {
      if (stats.total_validators !== undefined) {
        updateElement('total-validators', stats.total_validators.toLocaleString());
        updateElement('validators-location', `Network validators`);
      }
      
      if (stats.total_stake !== undefined) {
        const stakeM = (stats.total_stake / 1000000).toFixed(1);
        updateElement('total-stake', `${stakeM}M`);
      }
      
      if (stats.active_validators !== undefined) {
        updateElement('active-validators', stats.active_validators.toLocaleString());
        updateElement('active-validators-count', stats.active_validators.toLocaleString());
        updateElement('validators-trend', `${stats.active_validators} active`);
      }
    }

    // Update validator stats
    function updateValidatorStats(validators) {
      if (!validators || validators.length === 0) return;
      
      const totalValidators = validators.length;
      const totalStake = validators.reduce((sum, v) => sum + parseFloat(v.total_stake || 0), 0);
      const avgStake = totalValidators > 0 ? totalStake / totalValidators : 0;
      
      updateElement('avg-stake', `${(avgStake / 1000).toFixed(1)}K`);
    }

    // Update PQC algorithm distribution
    function updatePQCDistribution() {
      // For now, we'll use placeholder values since we need to analyze tx signatures
      // In a real implementation, we'd fetch recent transactions and analyze their signature algorithms
      const total = pqcStats.total || 100;
      const kyberPct = total > 0 ? ((pqcStats.kyber / total) * 100).toFixed(0) : 33;
      const dilithiumPct = total > 0 ? ((pqcStats.dilithium / total) * 100).toFixed(0) : 34;
      const sphincsPct = total > 0 ? ((pqcStats.sphincs / total) * 100).toFixed(0) : 33;
      
      updateElement('kyber-pct', `${kyberPct}%`);
      updateElement('dilithium-pct', `${dilithiumPct}%`);
      updateElement('sphincs-pct', `${sphincsPct}%`);
      updateElement('verification-success', '99.9%+');
    }

    // Helper to update element text content
    function updateElement(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    // Handle new block from WebSocket
    function handleNewBlock(block) {
      console.log('üì¶ New block:', block);
      
      // Update block height (API uses 'height' not 'number')
      if (block.height || block.number) {
        latestBlockHeight = block.height || block.number;
        updateElement('latest-block', latestBlockHeight.toLocaleString());
        
        // Update timestamp
        if (block.timestamp) {
          const timeAgo = calculateTimeAgo(block.timestamp);
          updateElement('latest-block-time', timeAgo);
        }
      }
      
      // Add to blocks feed
      const blocksFeed = document.getElementById('block-feed');
      if (blocksFeed && block) {
        const row = createBlockRow(block);
        blocksFeed.insertBefore(row, blocksFeed.firstChild);
        
        // Keep only last 5 blocks
        while (blocksFeed.children.length > 5) {
          blocksFeed.removeChild(blocksFeed.lastChild);
        }
      }
      
      // Re-fetch stats periodically with new blocks
      fetchBlockchainStats();
    }

    // Handle new transaction from WebSocket
    function handleNewTransaction(tx) {
      console.log('üí≥ New transaction:', tx);
      
      const txFeed = document.getElementById('tx-feed');
      if (txFeed && tx) {
        const row = createTransactionRow(tx);
        txFeed.insertBefore(row, txFeed.firstChild);
        
        // Keep only last 5 transactions
        while (txFeed.children.length > 5) {
          txFeed.removeChild(txFeed.lastChild);
        }
      }
    }

    // Create block table row
    function createBlockRow(block) {
      const tr = document.createElement('tr');
      tr.style.borderBottom = '1px solid rgba(87, 113, 153, 0.15)';
      
      const timeAgo = block.timestamp ? calculateTimeAgo(block.timestamp) : 'just now';
      const blockNum = block.height || block.number || 0;
      const txCount = block.txs ? block.txs.length : (block.transactions ? block.transactions.length : 0);
      const size = block.size ? `${Math.round(block.size / 1024)} KB` : 'N/A';
      const validator = block.validator || 'dyt1...';
      
      tr.innerHTML = `
        <td style="padding: 0.75rem;"><strong style="color: var(--text-primary);">#${blockNum.toLocaleString()}</strong><br><span style="font-size: 0.85rem; color: var(--text-muted);">${timeAgo}</span></td>
        <td style="padding: 0.75rem; color: var(--text-secondary);">${txCount}</td>
        <td style="padding: 0.75rem; color: var(--text-secondary);">${size}</td>
        <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">${validator.substring(0, 10)}...</span></td>
      `;
      
      return tr;
    }

    // Create transaction table row
    function createTransactionRow(tx) {
      const tr = document.createElement('tr');
      tr.style.borderBottom = '1px solid rgba(87, 113, 153, 0.15)';
      
      const timeAgo = tx.timestamp ? calculateTimeAgo(tx.timestamp) : 'just now';
      const hash = tx.hash || tx.tx_hash || '0x0000...';
      const algo = tx.algorithm || 'Kyber';
      const amount = tx.amount || tx.value || '0';
      const status = tx.status || 'Confirmed';
      
      const algoBadgeClass = algo === 'Dilithium' ? 'background: rgba(147, 51, 234, 0.25); border: 1px solid rgba(147, 51, 234, 0.4);' :
                             algo === 'SPHINCS+' ? 'background: rgba(245, 158, 11, 0.25); border: 1px solid rgba(245, 158, 11, 0.4);' :
                             '';
      
      tr.innerHTML = `
        <td style="padding: 0.75rem;"><span style="font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-secondary);">${hash.substring(0, 8)}...</span><br><span style="font-size: 0.85rem; color: var(--text-muted);">${timeAgo}</span></td>
        <td style="padding: 0.75rem;"><span class="badge badge-info" style="font-size: 0.75rem; ${algoBadgeClass}">${algo}</span></td>
        <td style="padding: 0.75rem; color: var(--text-secondary);">${amount} DYT</td>
        <td style="padding: 0.75rem;"><span class="badge badge-success" style="font-size: 0.75rem;">${status}</span></td>
      `;
      
      return tr;
    }

    // Calculate time ago
    function calculateTimeAgo(timestamp) {
      const now = Date.now() / 1000;
      const diff = now - timestamp;
      
      if (diff < 60) return `${Math.floor(diff)}s ago`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      return `${Math.floor(diff / 86400)}d ago`;
    }

    // Update blocks feed
    function updateBlocksFeed(blocks) {
      const feed = document.getElementById('block-feed');
      if (!feed || !blocks || !blocks.length) return;
      
      feed.innerHTML = '';
      blocks.slice(0, 5).forEach(block => {
        feed.appendChild(createBlockRow(block));
      });
    }

    // Update connection status
    function updateConnectionStatus(connected) {
      console.log(connected ? 'üü¢ Connected to blockchain' : 'üî¥ Disconnected from blockchain');
    }

    // Handle search form
    document.getElementById('blockchain-search')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      const searchValue = document.getElementById('explorer-search').value.trim();
      if (!searchValue) return;
      
      try {
        // Determine search type
        let endpoint = '';
        
        if (searchValue.startsWith('0x')) {
          // Transaction hash or block hash
          endpoint = `/tx/${searchValue}`;
        } else if (/^\d+$/.test(searchValue)) {
          // Block number
          endpoint = `/block/${searchValue}`;
        } else {
          // Address
          endpoint = `/balance/${searchValue}`;
        }
        
        const response = await fetch(`${BLOCKCHAIN_API}${endpoint}`);
        const data = await response.json();
        
        if (data.success) {
          alert(`Found!\n\n${JSON.stringify(data.data, null, 2)}`);
        } else {
          alert(`Not found: ${searchValue}`);
        }
      } catch (e) {
        console.error('Search error:', e);
        alert(`Error searching for: ${searchValue}\n\nMake sure the blockchain node is running at ${BLOCKCHAIN_API}`);
      }
    });

    // Handle chip toggle
    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', function() {
        this.classList.toggle('is-active');
      });
    });

    // Initialize
    async function init() {
      console.log('üöÄ Initializing Network Dashboard...');
      
      // Connect to WebSocket
      connectWebSocket();
      
      // Fetch initial data
      await fetchBlockchainStats();
      await fetchRecentBlocks();
      await fetchStakingStats();
      await fetchValidators();
      
      // Update PQC distribution
      updatePQCDistribution();
      
      // Poll for updates every 10 seconds (backup to WebSocket)
      setInterval(async () => {
        await fetchBlockchainStats();
        if (!isConnected) {
          await fetchRecentBlocks();
        }
        // Update staking stats every 30 seconds
        if (Date.now() % 30000 < 10000) {
          await fetchStakingStats();
          await fetchValidators();
        }
      }, 10000);
    }

    // Start when page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
