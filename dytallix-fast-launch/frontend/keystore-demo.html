<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PQC Keystore Demo</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #0a0a0a;
      color: #e0e0e0;
    }
    h1 {
      color: #fff;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
    }
    .section {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .section h2 {
      margin-top: 0;
      color: #60a5fa;
    }
    button {
      background: #60a5fa;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }
    button:hover {
      background: #3b82f6;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #444;
      border-radius: 4px;
      background: #2a2a2a;
      color: #e0e0e0;
      font-family: monospace;
    }
    .output {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 4px;
      padding: 12px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
    }
    .success {
      color: #22c55e;
    }
    .error {
      color: #ef4444;
    }
    .warning {
      color: #f59e0b;
    }
    label {
      display: block;
      margin: 10px 0 5px 0;
      font-weight: bold;
    }
    .info {
      background: #1e3a8a;
      border-left: 4px solid #60a5fa;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>üîê PQC Keystore Demo &amp; Verification</h1>
  
  <div class="info">
    <strong>‚ÑπÔ∏è Demo Script:</strong> This page demonstrates the PQC keystore export/import functionality.
    You can create a mock wallet, export it to an encrypted JSON keystore, and then import it back.
  </div>

  <!-- Export Section -->
  <div class="section">
    <h2>1. Export Keystore</h2>
    
    <label>Algorithm:</label>
    <select id="algorithm" style="padding: 8px; width: 100%; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444;">
      <option value="ML-DSA">ML-DSA (Dilithium)</option>
      <option value="SLH-DSA">SLH-DSA (SPHINCS+)</option>
    </select>
    
    <label>Password (min 8 chars):</label>
    <input type="password" id="exportPassword" placeholder="Enter a strong password" value="demo-password-123">
    
    <button id="exportBtn">Export Mock Wallet</button>
    
    <div id="exportOutput" class="output"></div>
  </div>

  <!-- Import Section -->
  <div class="section">
    <h2>2. Import Keystore</h2>
    
    <label>Keystore JSON:</label>
    <textarea id="importJson" rows="10" placeholder="Paste keystore JSON here"></textarea>
    
    <label>Password:</label>
    <input type="password" id="importPassword" placeholder="Enter password">
    
    <button id="importBtn">Import & Decrypt</button>
    
    <div id="importOutput" class="output"></div>
  </div>

  <!-- Verification Section -->
  <div class="section">
    <h2>3. Verification Results</h2>
    <div id="verifyOutput" class="output">Run export and import to see verification results...</div>
  </div>

  <script type="module">
    // Import keystore modules (adjust path as needed)
    import { exportKeystore, serializeKeystore, importKeystore } from './src/wallet/keystore/index.js';
    import { createMockWallet } from './src/wallet/pqc.js';

    let currentKeystore = null;
    let mockWallet = null;

    // Export functionality
    document.getElementById('exportBtn').addEventListener('click', async () => {
      const algorithm = document.getElementById('algorithm').value;
      const password = document.getElementById('exportPassword').value;
      const output = document.getElementById('exportOutput');
      
      if (!password || password.length < 8) {
        output.innerHTML = '<span class="error">‚ùå Password must be at least 8 characters</span>';
        return;
      }
      
      try {
        output.innerHTML = '<span class="warning">‚è≥ Generating wallet and encrypting...</span>';
        
        // Create mock wallet
        const addr = algorithm === 'ML-DSA' 
          ? 'pqc1ml' + Math.random().toString(36).slice(2, 42)
          : 'pqc1slh' + Math.random().toString(36).slice(2, 42);
        
        const pkSize = algorithm === 'ML-DSA' ? 1952 : 64;
        const skSize = algorithm === 'ML-DSA' ? 4032 : 128;
        
        const publicKey = new Uint8Array(pkSize);
        const privateKey = new Uint8Array(skSize);
        crypto.getRandomValues(publicKey);
        crypto.getRandomValues(privateKey);
        
        mockWallet = createMockWallet({ address: addr, algorithm, publicKey, privateKey });
        
        // Export keystore
        const keystore = await exportKeystore(mockWallet, { password });
        const json = await serializeKeystore(keystore);
        
        currentKeystore = json;
        
        // Display result
        output.innerHTML = `<span class="success">‚úì Keystore exported successfully!</span>\n\n`;
        output.innerHTML += `Address: ${addr}\n`;
        output.innerHTML += `Algorithm: ${algorithm}\n`;
        output.innerHTML += `Keystore size: ${json.length} bytes\n\n`;
        output.innerHTML += `JSON:\n${json.substring(0, 500)}...\n\n`;
        output.innerHTML += '<span class="success">Keystore copied to import field ‚Üì</span>';
        
        // Auto-fill import section
        document.getElementById('importJson').value = json;
        document.getElementById('importPassword').value = password;
        
      } catch (err) {
        output.innerHTML = `<span class="error">‚ùå Export failed: ${err.message}</span>`;
        console.error(err);
      }
    });

    // Import functionality
    document.getElementById('importBtn').addEventListener('click', async () => {
      const json = document.getElementById('importJson').value;
      const password = document.getElementById('importPassword').value;
      const output = document.getElementById('importOutput');
      const verifyOutput = document.getElementById('verifyOutput');
      
      if (!json) {
        output.innerHTML = '<span class="error">‚ùå Please paste a keystore JSON</span>';
        return;
      }
      
      if (!password) {
        output.innerHTML = '<span class="error">‚ùå Please enter password</span>';
        return;
      }
      
      try {
        output.innerHTML = '<span class="warning">‚è≥ Decrypting keystore...</span>';
        
        // Import keystore
        const result = await importKeystore(json, password);
        
        // Display result
        output.innerHTML = `<span class="success">‚úì Keystore imported successfully!</span>\n\n`;
        output.innerHTML += `Algorithm: ${result.algorithm}\n`;
        output.innerHTML += `Address: ${result.addressCheck}\n`;
        output.innerHTML += `Private key size: ${result.privateKey.length} bytes\n`;
        output.innerHTML += `Private key (first 32 bytes): ${Array.from(result.privateKey.slice(0, 32)).map(b => b.toString(16).padStart(2, '0')).join('')}\n`;
        
        // Verification
        if (mockWallet) {
          const originalAddr = await mockWallet.getAddress();
          const originalPk = await mockWallet.exportPrivateKeyRaw();
          
          const addressMatch = originalAddr === result.addressCheck;
          const pkMatch = Array.from(originalPk).every((byte, i) => byte === result.privateKey[i]);
          
          verifyOutput.innerHTML = `<span class="success">‚úì Verification Complete</span>\n\n`;
          verifyOutput.innerHTML += `Address match: ${addressMatch ? '<span class="success">‚úì YES</span>' : '<span class="error">‚úó NO</span>'}\n`;
          verifyOutput.innerHTML += `Private key match: ${pkMatch ? '<span class="success">‚úì YES</span>' : '<span class="error">‚úó NO</span>'}\n\n`;
          
          if (addressMatch && pkMatch) {
            verifyOutput.innerHTML += '<span class="success">üéâ Round-trip successful! The exported keystore correctly stores and recovers the wallet.</span>';
          } else {
            verifyOutput.innerHTML += '<span class="error">‚ö†Ô∏è Mismatch detected! The imported wallet does not match the original.</span>';
          }
        } else {
          verifyOutput.innerHTML = '<span class="warning">‚ÑπÔ∏è No original wallet to compare with</span>';
        }
        
      } catch (err) {
        output.innerHTML = `<span class="error">‚ùå Import failed: ${err.message}</span>\n\n`;
        if (err.name === 'DecryptionAuthError') {
          output.innerHTML += '<span class="error">Wrong password or corrupted keystore</span>';
        }
        console.error(err);
      }
    });
  </script>
</body>
</html>
