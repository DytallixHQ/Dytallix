# Audit Logging and Security Monitoring Configuration
# Enhanced audit logging for security events and compliance

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dytallix-audit-policy
  namespace: dytallix
  labels:
    security.dytallix.io/type: "audit-logging"
data:
  audit-policy.yaml: |
    apiVersion: audit.k8s.io/v1
    kind: Policy
    rules:
    # Log nothing from the following users and namespaces
    - level: None
      users: ["system:kube-proxy"]
      verbs: ["watch"]
      resources:
      - group: ""
        resources: ["endpoints", "services", "services/status"]

    - level: None
      namespaces: ["kube-system"]
      verbs: ["get"]
      resources:
      - group: ""
        resources: ["configmaps"]

    # Don't log these events
    - level: None
      resources:
      - group: ""
        resources: ["events"]

    # Log security-sensitive events at RequestResponse level
    - level: RequestResponse
      omitStages:
      - RequestReceived
      resources:
      - group: ""
        resources: ["secrets", "configmaps"]
      - group: "rbac.authorization.k8s.io"
        resources: ["roles", "clusterroles", "rolebindings", "clusterrolebindings"]
      - group: "apps"
        resources: ["deployments", "daemonsets", "statefulsets"]
      - group: "networking.k8s.io"
        resources: ["networkpolicies"]
      - group: "admissionregistration.k8s.io"
        resources: ["validatingadmissionwebhooks", "mutatingadmissionwebhooks"]

    # Log pod creation/deletion/update at Metadata level
    - level: Metadata
      omitStages:
      - RequestReceived
      resources:
      - group: ""
        resources: ["pods", "services"]
      - group: "apps"
        resources: ["deployments", "replicasets"]

    # Log authentication and authorization events
    - level: Request
      omitStages:
      - RequestReceived
      userGroups: ["system:unauthenticated"]

    # Log all security policy violations
    - level: RequestResponse
      omitStages:
      - RequestReceived
      verbs: ["create", "update", "patch", "delete"]
      resources:
      - group: "policy"
        resources: ["podsecuritypolicies"]
      - group: "security.istio.io"
        resources: ["authorizationpolicies", "requestauthentications"]

    # Default logging level for all other requests
    - level: Metadata
      omitStages:
      - RequestReceived

---
# Security event monitoring configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: dytallix-security-monitoring
  namespace: dytallix
  labels:
    security.dytallix.io/type: "security-monitoring"
data:
  monitoring-config.yaml: |
    # Security monitoring configuration
    securityMonitoring:
      # Enable security event collection
      enabled: true

      # Log aggregation settings
      logAggregation:
        # Send logs to Cloud Logging
        cloudLogging:
          enabled: true
          logName: "dytallix-security-audit"
          severity: "INFO"

        # Send logs to external SIEM
        externalSIEM:
          enabled: false
          endpoint: "https://siem.company.com/api/events"
          authentication:
            type: "bearer"
            token: "${SIEM_TOKEN}"

      # Alert configuration
      alerting:
        # Failed authentication attempts
        failedAuth:
          enabled: true
          threshold: 5
          timeWindow: "5m"
          severity: "WARNING"

        # Privilege escalation attempts
        privilegeEscalation:
          enabled: true
          threshold: 1
          timeWindow: "1m"
          severity: "CRITICAL"

        # Network policy violations
        networkPolicyViolations:
          enabled: true
          threshold: 10
          timeWindow: "5m"
          severity: "WARNING"

        # Pod security policy violations
        podSecurityViolations:
          enabled: true
          threshold: 1
          timeWindow: "1m"
          severity: "HIGH"

      # Metrics collection
      metrics:
        # Security-related metrics
        securityMetrics:
          enabled: true
          interval: "30s"
          labels:
            environment: "production"
            cluster: "dytallix-bridge"

---
# Prometheus security monitoring rules
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: dytallix-security-alerts
  namespace: dytallix
  labels:
    security.dytallix.io/type: "security-alerts"
spec:
  groups:
  - name: dytallix.security.rules
    interval: 30s
    rules:
    # High number of failed authentication attempts
    - alert: HighFailedAuthenticationAttempts
      expr: increase(apiserver_audit_total{verb="create",objectRef_resource="tokenreviews",objectRef_apiVersion="authentication.k8s.io/v1"}[5m]) > 10
      for: 1m
      labels:
        severity: warning
        security_event: authentication_failure
      annotations:
        summary: "High number of failed authentication attempts"
        description: "{{ $value }} failed authentication attempts in the last 5 minutes"

    # Privilege escalation detected
    - alert: PrivilegeEscalationDetected
      expr: increase(apiserver_audit_total{verb="create",objectRef_resource="pods",requestObject_spec_securityContext_privileged="true"}[1m]) > 0
      for: 0m
      labels:
        severity: critical
        security_event: privilege_escalation
      annotations:
        summary: "Privilege escalation attempt detected"
        description: "Privileged pod creation detected"

    # Network policy violations
    - alert: NetworkPolicyViolations
      expr: increase(calico_dropped_packets_total[5m]) > 50
      for: 2m
      labels:
        severity: warning
        security_event: network_policy_violation
      annotations:
        summary: "High number of network policy violations"
        description: "{{ $value }} packets dropped by network policies in the last 5 minutes"

    # Unauthorized access to secrets
    - alert: UnauthorizedSecretAccess
      expr: increase(apiserver_audit_total{verb=~"get|list",objectRef_resource="secrets",user_username!~"system:.*"}[5m]) > 5
      for: 1m
      labels:
        severity: high
        security_event: unauthorized_secret_access
      annotations:
        summary: "Unauthorized access to secrets detected"
        description: "{{ $value }} unauthorized secret access attempts in the last 5 minutes"

    # Pod security policy violations
    - alert: PodSecurityPolicyViolations
      expr: increase(apiserver_audit_total{verb="create",objectRef_resource="pods",responseStatus_code="403"}[5m]) > 0
      for: 0m
      labels:
        severity: high
        security_event: pod_security_violation
      annotations:
        summary: "Pod security policy violation detected"
        description: "Pod creation blocked by security policy"

    # Binary authorization failures
    - alert: BinaryAuthorizationFailures
      expr: increase(gatekeeper_audit_total{violation_kind="BinaryAuthorization"}[5m]) > 0
      for: 0m
      labels:
        severity: high
        security_event: binary_authorization_failure
      annotations:
        summary: "Binary authorization failure detected"
        description: "Container image failed binary authorization check"

    # Suspicious file access
    - alert: SuspiciousFileAccess
      expr: increase(auditd_file_access_total{file=~"/etc/.*|/var/.*|/usr/bin/.*"}[5m]) > 100
      for: 2m
      labels:
        severity: warning
        security_event: suspicious_file_access
      annotations:
        summary: "Suspicious file access pattern detected"
        description: "High volume of sensitive file access detected"

    # Container escape attempts
    - alert: ContainerEscapeAttempts
      expr: increase(container_escape_attempts_total[5m]) > 0
      for: 0m
      labels:
        severity: critical
        security_event: container_escape
      annotations:
        summary: "Container escape attempt detected"
        description: "Potential container escape attempt detected"

---
# Log forwarding configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: dytallix-log-forwarding
  namespace: dytallix
  labels:
    security.dytallix.io/type: "log-forwarding"
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         5
        Log_Level     info
        Daemon        off
        Parsers_File  parsers.conf
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020

    [INPUT]
        Name              tail
        Path              /var/log/audit/*.log
        Tag               audit.*
        Parser            audit_json
        Refresh_Interval  5
        Mem_Buf_Limit     50MB

    [INPUT]
        Name              systemd
        Tag               systemd.*
        Systemd_Filter    _SYSTEMD_UNIT=kubelet.service
        Read_From_Tail    On

    [FILTER]
        Name    grep
        Match   audit.*
        Regex   level (WARN|ERROR|CRITICAL|SECURITY)

    [FILTER]
        Name    modify
        Match   *
        Add     cluster dytallix-bridge
        Add     environment production
        Add     security_context true

    [OUTPUT]
        Name              stackdriver
        Match             *
        resource          k8s_container
        k8s_cluster_name  dytallix-bridge-cluster
        k8s_cluster_location us-central1-a
        labels_key        labels
        severity_key      severity
        tag_prefix        dytallix.security

    [OUTPUT]
        Name              forward
        Match             audit.*
        Host              security-siem.company.com
        Port              24224
        tls               on
        tls.verify        on