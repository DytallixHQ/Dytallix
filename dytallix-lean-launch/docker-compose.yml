version: "3.9"

x-node-env: &node-env
  DYT_CHAIN_ID: dytallix-mvp-1
  DYT_DATA_DIR: /var/lib/dytallix/data
  DYT_ENABLE_GOVERNANCE: "true"
  DYT_ENABLE_STAKING: "true"
  DYT_BLOCK_INTERVAL_MS: "1000"
  DYT_EMPTY_BLOCKS: "true"
  DY_METRICS: "1"
  DY_METRICS_ADDR: 0.0.0.0:9464
  DYT_GOV_MIN_DEPOSIT: "1000000000"
  DYT_GOV_DEPOSIT_PERIOD: "5"
  DYT_GOV_VOTING_PERIOD: "5"
  DYT_GOV_QUORUM_BPS: "3333"
  DYT_GOV_THRESHOLD_BPS: "5000"
  DYT_GOV_VETO_BPS: "3333"

x-node-service: &node-service
  build:
    context: .
    dockerfile: Dockerfile.node
  image: dytallix-lean-node:local
  restart: unless-stopped
  environment:
    <<: *node-env
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"
  healthcheck:
    test: ["CMD", "curl", "-sf", "http://localhost:3030/status"]
    interval: 10s
    timeout: 5s
    retries: 12

services:
  seed:
    <<: *node-service
    container_name: dyt-seed
    volumes:
      - seed-data:/var/lib/dytallix
    ports:
      - "3031:3030"
      - "9465:9464"
    environment:
      <<: *node-env
      DYT_NODE_ROLE: seed
      DYT_EMPTY_BLOCKS: "false"

  validator1:
    <<: *node-service
    container_name: dyt-validator-1
    volumes:
      - val1-data:/var/lib/dytallix
    ports:
      - "3032:3030"
      - "9466:9464"
    environment:
      <<: *node-env
      DYT_NODE_ROLE: validator
      DYT_VALIDATOR_NAME: validator1
      DYT_EMPTY_BLOCKS: "false"

  validator2:
    <<: *node-service
    container_name: dyt-validator-2
    volumes:
      - val2-data:/var/lib/dytallix
    ports:
      - "3033:3030"
      - "9467:9464"
    environment:
      <<: *node-env
      DYT_NODE_ROLE: validator
      DYT_VALIDATOR_NAME: validator2
      DYT_EMPTY_BLOCKS: "false"

  rpc:
    <<: *node-service
    container_name: dyt-rpc
    volumes:
      - rpc-data:/var/lib/dytallix
    ports:
      - "3030:3030"
      - "9464:9464"
    environment:
      <<: *node-env
      DYT_NODE_ROLE: rpc
      DYT_BLOCK_INTERVAL_MS: "800"
      DYT_EMPTY_BLOCKS: "true"
    depends_on:
      - seed
      - validator1
      - validator2

volumes:
  seed-data:
  val1-data:
  val2-data:
  rpc-data:
