version: "3.8"

services:
  node:
    build:
      context: ../..
      dockerfile: dytallix-lean-launch/Dockerfile.node
    image: dytallix-lean-node:lite
    container_name: dyt-node-lite
    restart: unless-stopped
    environment:
      DYT_CHAIN_ID: dytallix-lite
      DYT_NODE_ROLE: rpc
      DYT_DATA_DIR: /var/lib/dytallix/data
      DY_METRICS: "1"
      DY_METRICS_ADDR: 0.0.0.0:9464
      DYT_EMPTY_BLOCKS: "true"
      DYT_BLOCK_INTERVAL_MS: "2000"
    ports:
      - "3030:3030"   # RPC/HTTP
      - "9464:9464"   # Prometheus metrics
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3030/status"]
      interval: 10s
      timeout: 5s
      retries: 30

  frontend:
    image: nginx:alpine
    container_name: dyt-frontend-lite
    restart: unless-stopped
    depends_on:
      - node
      - explorer
      - faucet
      - api
    ports:
      - "80:8080"
      - "8080:8080"
    volumes:
      - ../../frontend/dist-testnet:/usr/share/nginx/html:ro
      - ./nginx-lite.conf:/etc/nginx/conf.d/default.conf:ro

  explorer:
    build:
      context: ../..
      dockerfile: explorer/Dockerfile
    image: dytallix-explorer:lite
    container_name: dyt-explorer-lite
    restart: unless-stopped
    environment:
      RPC_ENDPOINT: http://node:3030
      CHAIN_ID: ${CHAIN_ID:-dytallix-lite}
    depends_on:
      - node

  # Lean API server (server/index.js) providing /api endpoints (blocks, txs, faucet proxy)
  api:
    build:
      context: ../..
      dockerfile: deployment/lite/Dockerfile.api
    image: dytallix-api:lite
    container_name: dyt-api-lite
    restart: unless-stopped
    environment:
      PORT: "8787"
      RPC_HTTP_URL: ${RPC_HTTP_URL:-http://node:3030}
      VITE_RPC_HTTP_URL: ${VITE_RPC_HTTP_URL:-http://node:3030}
      VITE_LCD_HTTP_URL: ${VITE_LCD_HTTP_URL:-http://node:3030}
      CHAIN_ID: ${CHAIN_ID:-dytallix-lite}
      CHAIN_PREFIX: ${BECH32_PREFIX:-dyt}
      ENABLE_SEC_HEADERS: '1'
      ENABLE_CSP: '1'
    depends_on:
      - node

  faucet:
    build:
      context: ../..
      dockerfile: faucet/Dockerfile
    image: dytallix-faucet:lite
    container_name: dyt-faucet-lite
    working_dir: /app
    command: ["npm", "start"]
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      PORT: "8787"
      RPC_HTTP_URL: ${RPC_HTTP_URL:-http://node:3030}
      RPC_ENDPOINT: ${RPC_ENDPOINT:-http://node:3030}
      CHAIN_ID: ${CHAIN_ID:-dytallix-lite}
      CHAIN_PREFIX: ${BECH32_PREFIX:-dyt}
      FAUCET_MNEMONIC: ${FAUCET_MNEMONIC:-}
      FAUCET_MAX_PER_REQUEST_DGT: ${FAUCET_MAX_PER_REQUEST_DGT:-2}
      FAUCET_MAX_PER_REQUEST_DRT: ${FAUCET_MAX_PER_REQUEST_DRT:-50}
      FAUCET_GAS_PRICE: ${FAUCET_GAS_PRICE:-0.025uDRT}
      FAUCET_COOLDOWN_MINUTES: ${FAUCET_COOLDOWN_MINUTES:-60}
      ENABLE_SEC_HEADERS: '1'
      ENABLE_CSP: '1'
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8787/health"]
      interval: 15s
      timeout: 5s
      retries: 20
    depends_on:
      - node

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus-lite
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro

  grafana:
    image: grafana/grafana:latest
    container_name: grafana-lite
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file:
      - ./.env
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus

volumes:
  grafana_data:
