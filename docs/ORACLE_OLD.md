# Dytallix Oracle System Documentation

## Overview

The Dytallix Oracle system provides a secure, scalable ingestion pipeline for external AI risk scores associated with on-chain transactions. The system allows AI models to submit risk assessments that are persisted in node state and exposed via RPC for UI integration.

## Architecture

### Core Components

1. **OracleStore** - Persistent storage layer using RocksDB
2. **REST API** - HTTP endpoints for score submission  
3. **CLI Interface** - Command-line tools for oracle operations
4. **RPC Integration** - Risk scores exposed in transaction queries
5. **Signature Verification** - Optional cryptographic validation

### Data Model

```rust
pub struct AiRiskRecord {
    pub tx_hash: String,        // Transaction hash (hex format)
    pub model_id: String,       // AI model identifier 
    pub risk_score: f32,        // Risk score (0.0 to 1.0)
    pub confidence: Option<f32>, // Confidence level (0.0 to 1.0)
    pub signature: Option<String>, // Optional cryptographic signature
    pub oracle_pubkey: Option<String>, // Oracle's public key
}
```

## API Endpoints

### Single Risk Score Submission

**Endpoint:** `POST /oracle/ai_risk`

**Request Body:**
```json
{
    "tx_hash": "0x1234567890abcdef...",
    "model_id": "fraud-detector-v2.1",
    "risk_score": 0.75,
    "confidence": 0.92,
    "signature": "base64-encoded-signature"
}
```

**Response:**
```json
{
    "ok": true
}
```

### Batch Risk Score Submission

**Endpoint:** `POST /oracle/ai_risk_batch`

**Request Body:**
```json
{
    "records": [
        {
            "tx_hash": "0x1234...",
            "model_id": "fraud-detector-v2.1", 
            "risk_score": 0.75,
            "confidence": 0.92,
            "signature": "base64-signature"
        },
        {
            "tx_hash": "0x5678...",
            "model_id": "ml-risk-engine-v1.0",
            "risk_score": 0.23,
            "confidence": 0.88
        }
    ]
}
```

**Response:**
```json
{
    "processed": 2,
    "failed": 0,
    "failed_hashes": [],
    "validation_errors": []
}
```

### Transaction Query with Risk Scores

**Endpoint:** `GET /tx/{hash}`

**Response includes risk data:**
```json
{
    "hash": "0x1234567890abcdef...",
    "status": "success",
    "from": "dyt1sender...",
    "to": "dyt1recipient...",
    "amount": 1000,
    "ai_risk_score": 0.75,
    "ai_model_id": "fraud-detector-v2.1",
    "ai_confidence": 0.92
}
```

## CLI Usage

### Install CLI
```bash
cargo install --path cli
```

### Submit Single Risk Score
```bash
dcli oracle submit \
  --tx-hash 0x1234567890abcdef... \
  --model-id fraud-detector-v2.1 \
  --risk-score 0.75 \
  --confidence 0.92
```

### Submit Batch Risk Scores
```bash
# Create batch file
cat > risk_scores.json << EOF
[
    {
        "tx_hash": "0x1234...",
        "model_id": "fraud-detector-v2.1",
        "risk_score": 0.75,
        "confidence": 0.92
    },
    {
        "tx_hash": "0x5678...", 
        "model_id": "ml-risk-engine-v1.0",
        "risk_score": 0.23,
        "confidence": 0.88
    }
]
EOF

# Submit batch
dcli oracle submit-batch --file risk_scores.json
```

### Query Risk Score
```bash
dcli oracle query 0x1234567890abcdef...
```

## Security Features

### Optional Signature Verification

Set environment variable to enable signature verification:
```bash
export AI_ORACLE_PUBKEY="base64-encoded-public-key"
```

When enabled, all submissions must include a valid signature. The signature is generated by signing the message `{tx_hash}:{risk_score}` with the oracle's private key.

### Rate Limiting

The oracle endpoints include built-in rate limiting to prevent abuse:
- Single submissions: Limited by standard HTTP rate limiting
- Batch submissions: Additional validation on batch size and content
- Failed submissions are logged and monitored

### Validation Rules

1. **Transaction Hash**
   - Must be hex format starting with "0x"
   - Minimum length of 3 characters

2. **Risk Score** 
   - Must be between 0.0 and 1.0 (inclusive)
   - Required field

3. **Confidence**
   - Must be between 0.0 and 1.0 (inclusive) 
   - Optional field

4. **Model ID**
   - Cannot be empty or whitespace-only
   - Required field

## Integration Examples

### Python Integration
```python
import requests
import json

def submit_risk_score(tx_hash, model_id, risk_score, confidence=None):
    url = "http://localhost:3030/oracle/ai_risk"
    payload = {
        "tx_hash": tx_hash,
        "model_id": model_id, 
        "risk_score": risk_score,
        "confidence": confidence
    }
    
    response = requests.post(url, json=payload)
    return response.json()

# Submit single score
result = submit_risk_score(
    tx_hash="0x1234567890abcdef...",
    model_id="fraud-detector-v2.1",
    risk_score=0.75,
    confidence=0.92
)
print(result)
```

### JavaScript Integration
```javascript
async function submitRiskScore(txHash, modelId, riskScore, confidence) {
    const response = await fetch('http://localhost:3030/oracle/ai_risk', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            tx_hash: txHash,
            model_id: modelId,
            risk_score: riskScore,
            confidence: confidence
        })
    });
    
    return await response.json();
}

// Submit batch scores
async function submitBatchRiskScores(records) {
    const response = await fetch('http://localhost:3030/oracle/ai_risk_batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ records })
    });
    
    return await response.json();
}
```

## Deployment Configuration

### Environment Variables

- `AI_ORACLE_PUBKEY` - Base64-encoded public key for signature verification (optional)
- `DYT_DATA_DIR` - Data directory for node storage (default: "./data")
- `DYT_CHAIN_ID` - Chain identifier for the network

### Database Storage

Risk scores are stored in RocksDB with the key format:
```
oracle:ai:{tx_hash}
```

Data is persisted across node restarts and stored efficiently for fast retrieval.

### Monitoring and Logging

The oracle system provides comprehensive logging:
- Submission successes and failures
- Validation errors with specific details
- Signature verification results
- Batch processing statistics

## Error Handling

### Common Error Codes

1. **Invalid Risk Score Range**
   ```
   risk_score must be between 0.0 and 1.0
   ```

2. **Invalid Transaction Hash**
   ```
   Invalid tx_hash format
   ```

3. **Signature Verification Failed**
   ```
   Invalid signature for submitted data
   ```

4. **Empty Model ID**
   ```
   model_id cannot be empty
   ```

### Batch Processing Errors

Batch submissions use partial success semantics:
- Valid records are stored successfully
- Invalid records are skipped with detailed error reporting
- Response includes counts and specific failure information

## Performance Considerations

### Throughput

- Single submissions: ~1000 req/sec
- Batch submissions: Up to 100 records per batch
- Database writes are optimized for high throughput

### Storage

- Each risk record requires ~200-500 bytes of storage
- RocksDB provides efficient compression and indexing
- Storage scales linearly with transaction volume

### Caching

- Risk scores are cached in memory for fast retrieval
- Transaction queries include risk data without additional database lookups
- Cache is automatically invalidated on updates

## Testing

### Unit Tests
```bash
cd dytallix-lean-launch/node
cargo test oracle
```

### Integration Tests
```bash
# Start local node
cargo run

# Test API endpoints
curl -X POST http://localhost:3030/oracle/ai_risk \
  -H "Content-Type: application/json" \
  -d '{
    "tx_hash": "0x1234567890abcdef",
    "model_id": "test-model",
    "risk_score": 0.5
  }'

# Test CLI
dcli oracle submit --tx-hash 0x1234... --model-id test --risk-score 0.5
```

## Troubleshooting

### Common Issues

1. **"Invalid signature" errors**
   - Verify AI_ORACLE_PUBKEY is correctly set
   - Check signature generation matches expected format
   - Ensure message format is `{tx_hash}:{risk_score}`

2. **"Transaction not found" in queries**
   - Verify transaction hash exists in blockchain
   - Check that risk score was successfully submitted
   - Confirm proper hex formatting of hash

3. **Batch submission partial failures**
   - Review validation_errors in response
   - Check individual record formatting
   - Verify all required fields are present

### Debug Mode

Enable debug logging:
```bash
RUST_LOG=debug cargo run
```

## Future Enhancements

### Planned Features

1. **WebSocket Support** - Real-time risk score streaming
2. **Advanced Rate Limiting** - Per-model and per-source limits  
3. **Metrics Dashboard** - Oracle submission statistics and monitoring
4. **Model Performance Tracking** - Accuracy metrics and A/B testing
5. **Multi-Model Aggregation** - Combining scores from multiple AI models

### API Versioning

Future API versions will maintain backward compatibility:
- `/v1/oracle/ai_risk` - Current API
- `/v2/oracle/ai_risk` - Future enhanced API with additional features

---

For additional support, please refer to the main Dytallix documentation or submit issues to the project repository.