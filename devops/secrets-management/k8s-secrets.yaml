apiVersion: v1
kind: Namespace
metadata:
  name: dytallix-system
  labels:
    name: dytallix-system
    security.dytallix.io/pqc-enabled: "true"
---
apiVersion: v1
kind: Secret
metadata:
  name: dytallix-pqc-keys-dev
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: crypto
    app.kubernetes.io/part-of: dytallix
    dytallix.io/environment: dev
    dytallix.io/secret-type: pqc-keys
type: Opaque
data:
  # Base64 encoded PQC keys file
  # Replace with actual base64 encoded content from pqc_keys_dev.json.enc
  pqc_keys.json.enc: ""
---
apiVersion: v1
kind: Secret
metadata:
  name: dytallix-keys-password-dev
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: crypto
    app.kubernetes.io/part-of: dytallix
    dytallix.io/environment: dev
    dytallix.io/secret-type: password
type: Opaque
data:
  # Base64 encoded password
  # Replace with actual base64 encoded password
  password: ""
---
apiVersion: v1
kind: Secret
metadata:
  name: dytallix-database-dev
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: dytallix
    dytallix.io/environment: dev
    dytallix.io/secret-type: database
type: Opaque
data:
  # Base64 encoded database credentials
  host: bG9jYWxob3N0  # localhost
  port: NTQzMg==      # 5432
  database: ZHl0YWxsaXhfZGV2  # dytallix_dev
  username: ZHl0YWxsaXhfZGV2  # dytallix_dev
  password: ""  # Replace with actual base64 encoded password
---
apiVersion: v1
kind: Secret
metadata:
  name: dytallix-api-keys-dev
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: dytallix
    dytallix.io/environment: dev
    dytallix.io/secret-type: api-keys
type: Opaque
data:
  # Base64 encoded API keys
  api_key: ""      # Replace with actual base64 encoded API key
  jwt_secret: ""   # Replace with actual base64 encoded JWT secret
---
apiVersion: v1
kind: Secret
metadata:
  name: dytallix-tls-certs-dev
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: tls
    app.kubernetes.io/part-of: dytallix
    dytallix.io/environment: dev
    dytallix.io/secret-type: tls
type: kubernetes.io/tls
data:
  # Base64 encoded TLS certificate and key
  tls.crt: ""  # Replace with actual base64 encoded certificate
  tls.key: ""  # Replace with actual base64 encoded private key
---
apiVersion: v1
kind: Secret
metadata:
  name: dytallix-vault-config-dev
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: vault
    app.kubernetes.io/part-of: dytallix
    dytallix.io/environment: dev
    dytallix.io/secret-type: vault
type: Opaque
data:
  # Base64 encoded Vault configuration
  vault_url: ""    # Replace with actual base64 encoded Vault URL
  vault_token: ""  # Replace with actual base64 encoded Vault token
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dytallix-config-dev
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: dytallix
    dytallix.io/environment: dev
data:
  DYTALLIX_ENVIRONMENT: "dev"
  DYTALLIX_LOG_LEVEL: "debug"
  DYTALLIX_DEBUG_MODE: "true"
  DYTALLIX_BIND_ADDRESS: "0.0.0.0"
  DYTALLIX_PORT: "8080"
  DYTALLIX_METRICS_PORT: "9090"
  DYTALLIX_HEALTH_CHECK_PORT: "8081"
  DYTALLIX_P2P_PORT: "30303"
  DYTALLIX_P2P_DISCOVERY_PORT: "30304"
  DYTALLIX_P2P_MAX_PEERS: "50"
  DYTALLIX_REQUIRE_TLS: "false"
  DYTALLIX_MIN_TLS_VERSION: "1.2"
  DYTALLIX_AUDIT_LOGGING: "false"
  DYTALLIX_METRICS_ENABLED: "true"
  DYTALLIX_LOG_FORMAT: "json"
  DYTALLIX_KEY_ROTATION_INTERVAL: "720"
  DYTALLIX_PREFERRED_SIGNATURE_ALGORITHM: "Dilithium5"
  DYTALLIX_PREFERRED_KEM_ALGORITHM: "Kyber1024"
  DYTALLIX_AI_SERVICE_ENABLED: "true"
  DYTALLIX_AI_SERVICE_BASE_URL: "http://dytallix-ai-service:8000"
  DYTALLIX_AI_SERVICE_TIMEOUT: "30"
  DYTALLIX_AI_SERVICE_MAX_RETRIES: "3"
  DYTALLIX_AI_LOW_RISK_THRESHOLD: "0.3"
  DYTALLIX_AI_HIGH_RISK_THRESHOLD: "0.7"
  DYTALLIX_AI_FRAUD_THRESHOLD: "0.8"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dytallix-node-dev
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: node
    app.kubernetes.io/part-of: dytallix
    dytallix.io/environment: dev
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: dytallix
      app.kubernetes.io/component: node
      dytallix.io/environment: dev
  template:
    metadata:
      labels:
        app.kubernetes.io/name: dytallix
        app.kubernetes.io/component: node
        dytallix.io/environment: dev
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: dytallix-node
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
      - name: dytallix-node
        image: dytallix:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        - containerPort: 9090
          name: metrics
          protocol: TCP
        - containerPort: 8081
          name: health
          protocol: TCP
        - containerPort: 30303
          name: p2p
          protocol: TCP
        env:
        - name: DYTALLIX_PQC_KEYS_PATH
          value: "/etc/dytallix/secrets/pqc_keys.json.enc"
        - name: DYTALLIX_KEYS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dytallix-keys-password-dev
              key: password
        - name: DYTALLIX_DB_HOST
          valueFrom:
            secretKeyRef:
              name: dytallix-database-dev
              key: host
        - name: DYTALLIX_DB_PORT
          valueFrom:
            secretKeyRef:
              name: dytallix-database-dev
              key: port
        - name: DYTALLIX_DB_NAME
          valueFrom:
            secretKeyRef:
              name: dytallix-database-dev
              key: database
        - name: DYTALLIX_DB_USER
          valueFrom:
            secretKeyRef:
              name: dytallix-database-dev
              key: username
        - name: DYTALLIX_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dytallix-database-dev
              key: password
        - name: DYTALLIX_API_KEY
          valueFrom:
            secretKeyRef:
              name: dytallix-api-keys-dev
              key: api_key
        - name: DYTALLIX_JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: dytallix-api-keys-dev
              key: jwt_secret
        - name: VAULT_ADDR
          valueFrom:
            secretKeyRef:
              name: dytallix-vault-config-dev
              key: vault_url
              optional: true
        - name: VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: dytallix-vault-config-dev
              key: vault_token
              optional: true
        envFrom:
        - configMapRef:
            name: dytallix-config-dev
        volumeMounts:
        - name: pqc-keys
          mountPath: /etc/dytallix/secrets
          readOnly: true
        - name: tls-certs
          mountPath: /etc/dytallix/tls
          readOnly: true
        - name: data
          mountPath: /var/lib/dytallix
        - name: logs
          mountPath: /var/log/dytallix
        livenessProbe:
          httpGet:
            path: /health
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /ready
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2
            memory: 4Gi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
      volumes:
      - name: pqc-keys
        secret:
          secretName: dytallix-pqc-keys-dev
          defaultMode: 0400
      - name: tls-certs
        secret:
          secretName: dytallix-tls-certs-dev
          defaultMode: 0400
      - name: data
        persistentVolumeClaim:
          claimName: dytallix-data-dev
      - name: logs
        emptyDir: {}
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dytallix-node
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: node
    app.kubernetes.io/part-of: dytallix
automountServiceAccountToken: true
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: dytallix-node
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: node
    app.kubernetes.io/part-of: dytallix
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dytallix-node
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: node
    app.kubernetes.io/part-of: dytallix
subjects:
- kind: ServiceAccount
  name: dytallix-node
  namespace: dytallix-system
roleRef:
  kind: Role
  name: dytallix-node
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Service
metadata:
  name: dytallix-node-dev
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: node
    app.kubernetes.io/part-of: dytallix
    dytallix.io/environment: dev
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 8080
    targetPort: 8080
    protocol: TCP
  - name: metrics
    port: 9090
    targetPort: 9090
    protocol: TCP
  - name: health
    port: 8081
    targetPort: 8081
    protocol: TCP
  selector:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: node
    dytallix.io/environment: dev
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: dytallix-data-dev
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: storage
    app.kubernetes.io/part-of: dytallix
    dytallix.io/environment: dev
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: fast-ssd
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: dytallix-node-dev
  namespace: dytallix-system
  labels:
    app.kubernetes.io/name: dytallix
    app.kubernetes.io/component: node
    app.kubernetes.io/part-of: dytallix
    dytallix.io/environment: dev
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: dytallix
      app.kubernetes.io/component: node
      dytallix.io/environment: dev
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: dytallix-system
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090
    - protocol: TCP
      port: 8081
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: dytallix-system
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 5432
  - to: []
    ports:
    - protocol: TCP
      port: 30303
    - protocol: TCP
      port: 30304
