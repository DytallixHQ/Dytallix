{{- if .Values.emissions.cron.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Values.emissions.cron.serviceAccountName | default "dytallix-emissions" }}
  labels:
    app.kubernetes.io/name: dytallix-lean-launch
    app.kubernetes.io/component: emissions
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: dytallix-emissions-logs
  labels:
    app.kubernetes.io/name: dytallix-lean-launch
    app.kubernetes.io/component: emissions
spec:
  accessModes: [ "ReadWriteOnce" ]
  resources:
    requests:
      storage: {{ .Values.emissions.cron.logPvc.size | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dytallix-emissions-script
  labels:
    app.kubernetes.io/name: dytallix-lean-launch
    app.kubernetes.io/component: emissions
data:
  emissions_cron.sh: |
{{- /* Inline a minimal runner that installs deps and runs the main script logic */}}
    #!/usr/bin/env sh
    set -eu
    if command -v apk >/dev/null 2>&1; then apk add --no-cache curl jq yq >/dev/null 2>&1 || true; fi
    chmod +x /opt/dyt/scripts/emissions_cron.sh
    export RPC="${RPC:-{{ .Values.emissions.cron.rpcUrl }}}"
    export SCHEDULE="${SCHEDULE:-/etc/dyt/emissions/schedule.yaml}"
    export LOG_DIR="${LOG_DIR:-/var/log/dytallix-emissions}"
    export RETENTION_DAYS="${RETENTION_DAYS:-{{ .Values.emissions.cron.logPvc.retentionDays | default 14 }}}"
    /opt/dyt/scripts/emissions_cron.sh
  script.sh: |
    #!/usr/bin/env sh
    set -eu
    : "${RPC:=http://dytallix-rpc.dytallix.svc.cluster.local:3030}"
    : "${SCHEDULE:=/etc/dyt/emissions/schedule.yaml}"
    : "${LOG_DIR:=/var/log/dytallix-emissions}"
    mkdir -p "$LOG_DIR/.state"
    LOG_FILE="$LOG_DIR/$(date -u +%Y%m%d).log"
    log() { echo "[emissions] $*" | tee -a "$LOG_FILE"; }
    need() { command -v "$1" >/dev/null 2>&1 || { log "Missing tool: $1"; exit 1; }; }
    need curl; need jq; need yq
    if [ -n "${RETENTION_DAYS:-}" ]; then find "$LOG_DIR" -maxdepth 1 -type f -name '*.log' -mtime "+$RETENTION_DAYS" -print -delete || true; fi
    HEIGHT=$(curl -fsS "$RPC/api/stats" | jq -r '.height')
    [ -z "$HEIGHT" ] && { log "cannot get height"; exit 1; }
    log "height=$HEIGHT"
    [ -s "$SCHEDULE" ] || { log "No schedule"; exit 0; }
    COUNT=$(yq '.entries | length' "$SCHEDULE" 2>/dev/null || echo 0)
    i=0
    while [ $i -lt $COUNT ]; do
      entry=$(yq ".entries[$i]" "$SCHEDULE")
      e_height=$(echo "$entry" | yq '.height')
      pool=$(echo "$entry" | yq -r '.pool')
      to=$(echo "$entry" | yq -r '.to')
      amt=$(echo "$entry" | yq -r '.amount_udrt')
      [ "$e_height" = "null" ] && e_height=0
      [ "$amt" = "null" ] && amt=0
      key="${e_height}_${pool}_${to}_${amt}"
      stamp="$LOG_DIR/.state/$key.stamp"
      if [ "$e_height" -le "$HEIGHT" ]; then
        if [ -f "$stamp" ]; then
          log "skip height=$e_height pool=$pool to=$to amount_udrt=$amt status=already_applied"
        else
          body=$(printf '{"pool":"%s","amount":%s,"to":"%s"}' "$pool" "$amt" "$to")
          resp=$(curl -fsS -X POST "$RPC/emission/claim" -H 'Content-Type: application/json' -d "$body" || true)
          if echo "$resp" | jq -e . >/dev/null 2>&1; then
            remaining=$(echo "$resp" | jq -r '.remaining // ""')
            log "apply height=$e_height denom=uDRT pool=$pool to=$to amount_udrt=$amt remaining=${remaining} status=applied"
            date -u +%FT%TZ > "$stamp"
          else
            log "apply height=$e_height denom=uDRT pool=$pool to=$to amount_udrt=$amt status=error resp=$(printf %s "$resp" | tr '\n' ' ')"
          fi
        fi
      else
        log "future height=$e_height pool=$pool to=$to amount_udrt=$amt status=pending"
      fi
      i=$((i+1))
    done
    log "done height=$HEIGHT"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: dytallix-emissions
  labels:
    app.kubernetes.io/name: dytallix-lean-launch
    app.kubernetes.io/component: emissions
spec:
  schedule: {{ .Values.emissions.cron.schedule | quote }}
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: dytallix-lean-launch
            app.kubernetes.io/component: emissions
        spec:
          serviceAccountName: {{ .Values.emissions.cron.serviceAccountName | default "dytallix-emissions" }}
          restartPolicy: OnFailure
          containers:
            - name: emissions
              image: {{ .Values.emissions.cron.image | quote }}
              imagePullPolicy: IfNotPresent
              command: ["/bin/sh","-c","/entrypoint/runner.sh"]
              env:
                - name: RPC
                  value: {{ .Values.emissions.cron.rpcUrl | quote }}
                - name: SCHEDULE
                  value: "/etc/dyt/emissions/schedule.yaml"
                - name: LOG_DIR
                  value: "/var/log/dytallix-emissions"
                - name: RETENTION_DAYS
                  value: {{ .Values.emissions.cron.logPvc.retentionDays | quote }}
              resources:
{{ toYaml .Values.emissions.cron.resources | indent 16 }}
              volumeMounts:
                - name: runner
                  mountPath: /entrypoint
                - name: cron-script
                  mountPath: /opt/dyt/scripts/emissions_cron.sh
                  subPath: script.sh
                - name: schedule
                  mountPath: /etc/dyt/emissions/schedule.yaml
                  subPath: schedule.yaml
                - name: logs
                  mountPath: /var/log/dytallix-emissions
          volumes:
            - name: runner
              projected:
                sources:
                  - configMap:
                      name: dytallix-emissions-script
                      items:
                        - key: emissions_cron.sh
                          path: runner.sh
            - name: cron-script
              configMap:
                name: dytallix-emissions-script
                items:
                  - key: script.sh
                    path: script.sh
            - name: schedule
              configMap:
                name: dytallix-emissions-schedule
            - name: logs
              persistentVolumeClaim:
                claimName: dytallix-emissions-logs
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dytallix-emissions-schedule
  labels:
    app.kubernetes.io/name: dytallix-lean-launch
    app.kubernetes.io/component: emissions
data:
  schedule.yaml: |
    entries: []
---
{{- if .Values.emissions.networkPolicy.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: dytallix-emissions
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: dytallix-lean-launch
      app.kubernetes.io/component: emissions
  policyTypes:
    - Egress
  egress:
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
    # RPC internal service
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: {{ .Release.Namespace }}
      ports:
        - port: 3030
          protocol: TCP
{{- end }}
{{- end }}
